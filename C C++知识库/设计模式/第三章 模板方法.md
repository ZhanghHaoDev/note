# 第三章 模板方法

# GOF-23模式分类

1. 从目的来看：
- 创建型模式：将对象的部分创建工作延迟子类或者其他对象，从而应对需求变化为对象创建时
- 结构型模式：通过类继承或者对象组合
- 行为型模式：通过类继承或者对象组合
1. 从范围来看
- 类模式处理类与子类的静态关系
- 对象模式处理对象之间的动态关系

# 重构获得模式

1. 面向对象设计模式是“好的面向对象设计”，所谓“好的面向对象设计”指的是那些可以满足“应对变化，提高复用”的设计
2. 现代软件的特征是“需求的频繁变化”。设计模式的要点是：“寻找变化点”，然后在变化点出应用设计模式，从而来应对需求的变化，“什么时候，什么地点应用设计模式”比“理解设计模式结构本身”更为重要
3. 设计模式的应用不宜先入为主，一上来就使用设计模式是对设计模式的最大误用。没有一步到位的设计模式。敏捷开发事件提倡的“重构获得模式”是目前普遍公认的最好的设计模式的方法
4. 推荐书籍：《重构与模式》，《重构-改善既有代码的设计》

# 重构关键继技法

静态-》动态

早绑定-》晚绑定

继承-》组合

编译时依赖-》运行时依赖

紧耦合-》松耦合

# “组件协作”模式

1. 现代软件专业分工之后的第一个结果是“框架与应用的区分”，“组件协作”模式通过晚期绑定，来实现框架之间的松耦合，是二者之间协作时常用的模式
2. 经典模式
- Template Method
- Strategy
- Observer / Event

# 动机

1. 在软件构建过程中，对于某一项认为，他常常有稳定的整体操作结构，但各个子步骤却有很多改变的需求，或者由于固有的原因（比如框架与应用之间的关系），而无法和任务的整体结构同时实现
2. 如何在确定操作结构的前提下，来灵活应对各个子步骤的变化或者晚期实现需求？

# 结构化软件设计流程

![https://cdn.nlark.com/yuque/0/2024/png/23087967/1717314352216-97811245-40d7-46cb-a422-169c40fda264.png](https://cdn.nlark.com/yuque/0/2024/png/23087967/1717314352216-97811245-40d7-46cb-a422-169c40fda264.png)

---

# 面向对象软件设计流程

![https://cdn.nlark.com/yuque/0/2024/png/23087967/1717314352496-8800a444-c7e5-4f4e-baf3-58b6b0f02566.png](https://cdn.nlark.com/yuque/0/2024/png/23087967/1717314352496-8800a444-c7e5-4f4e-baf3-58b6b0f02566.png)

---

# 早绑定与晚绑定

![https://cdn.nlark.com/yuque/0/2024/png/23087967/1717314351771-cc22ec29-5ddd-44d2-86db-a602e8629fd9.png](https://cdn.nlark.com/yuque/0/2024/png/23087967/1717314351771-cc22ec29-5ddd-44d2-86db-a602e8629fd9.png)

---

在早期程序设计的时候：做法是先编写依赖的算法，然后程序再调用算法

在面向对象设计的时候：是先定义类，然后类再去调用算法

虚函数是面向对象语言的晚绑定机制

在c语言里面是函数指针，虚函数的底层是一个函数指针（挂载在虚函数表）

# 模式定义

1. 定义应一个操作中的算法的骨架（稳定），而将一些步骤延迟（变化）到子类中，Template Method使得子类可以不改变（复用）一个算法的结构可重定义（override 重写）该算法的某些特定步骤

```cpp
class Libray{

public:

// 稳定 template method

void Run(){

Step1();

if(Step()){ // 支持变化==》虚函数的多态调用

Step3();

}

for(int i = 0; i < 4;i++){

Step4(); // 支持变化==》虚函数的多态调用

}

Step5();

}

};
```

---

1. 在c++中稳定的（不改变）的算法需要写成普通的函数，改变的（不稳定）的函数需要写成虚函数（支持修改）
2. 设计模式的作用是：将变化和稳定隔离

# 结构

![https://cdn.nlark.com/yuque/0/2024/png/23087967/1717314351980-7d554486-1b3f-4e06-a0c2-a0544718cdae.png](https://cdn.nlark.com/yuque/0/2024/png/23087967/1717314351980-7d554486-1b3f-4e06-a0c2-a0544718cdae.png)

---

红色部分是不变化的，蓝色部分是变化的

# 总结

1. Template Method模式是一种非常基础性的设计模式，在面向对象系统中有着大量的应用。他用最简洁的机制（虚函数的多态性）为很多应用程序框架提供了灵活的扩展点，是代码复用方面的基本实现结构
2. 除了可以灵活应对子步骤的变化外，“不要调用我，让我来调用你”的反向控制结构是Template Method的典型应用
3. 在具体实现方面，被Template Method调用的虚方法可以具有实现，也可以没有任何实现（抽象方法，纯虚函方法），但一般推荐将他们设置为protected方法