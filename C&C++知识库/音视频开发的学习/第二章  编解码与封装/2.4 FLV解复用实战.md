# 1. 总体流程

## 1.1. main函数

- 功能：程序的入口点，负责读取命令行参数，打开FLV文件，并调用处理函数。
- 代码示例：

```cpp
#include <iostream>
#include <fstream>
#include <vector>

using namespace std;

// 声明Process函数
void Process(fstream& fin, const char* outputFilename);

int main(int argc, char *argv[]){
    cout << "Hi, this is FLV parser test program!\n";
    if (argc != 3){
        cout << "Usage: FlvParser.exe [input flv] [output flv]" << endl;
        return 0;
    }
    fstream fin;
    fin.open(argv[1], ios_base::in | ios_base::binary);
    if (!fin){
        cerr << "Error opening input file." << endl;
        return 0;
    }
    Process(fin, argv[2]);
    fin.close();
    cout << "Processing completed." << endl;
    return 1;
}
```

## 1.2. 处理函数Process

- 功能：处理FLV文件，包括解析和可能的转码。
- 代码示例：

```cpp
void Process(fstream& fin, const char* outputFilename){
    // 读取并解析FLV文件
    FLVHeader header;
    fin.read((char*)&header, sizeof(FLVHeader));
    
    // 将解析后的数据写入输出文件
    ofstream fout(outputFilename, ios_base::out | ios_base::binary);
    if (!fout){
        cerr << "Error opening output file." << endl;
        return;
    }
    fout.write((const char*)&header, sizeof(FLVHeader));

    TagHeader tagHeader;
    while (fin.read((char*)&tagHeader, sizeof(TagHeader))){
        uint8_t tagData[tagHeader.dataSize];
        fin.read((char*)tagData, tagHeader.dataSize);
        fout.write((const char*)&tagHeader, sizeof(TagHeader));
        fout.write((const char*)tagData, tagHeader.dataSize);
    }
    fout.close();
}
```

## 1.3. 解析函数

- 功能：负责解析FLV文件的不同部分，如头部、标签等。
- 代码示例：

```cpp
struct FLVHeader{
    char signature[3]; // "FLV"
    char version;      // 版本号
    uint32_t flags;
    uint32_t headerSize;
};

struct TagHeader{
    uint8_t tagType;
    uint32_t dataSize;
    uint32_t timestamp;
    uint32_t streamId;
};

void ParseFlvHeader(fstream& fin, FLVHeader& header){
    fin.read(header.signature, 3);
    header.version = fin.get();
    fin.read((char*)&header.flags, 3);
    header.headerSize = (header.flags & 0x01) ? 0x09 : 0x05;
}

void ParseTags(fstream& fin, const FLVHeader& header){
    TagHeader tagHeader;
    while (fin.read((char*)&tagHeader, sizeof(TagHeader))){
        uint8_t tagData[tagHeader.dataSize];
        fin.read((char*)tagData, tagHeader.dataSize);
        // 处理标签数据
    }
}
```

# 2. FLV相关的数据结构

## 2.1. CFlvParsar表示FLV解析器

- 功能：封装了FLV文件解析的所有逻辑。
- 代码示例：

```cpp
class CFlvParser{
public:
    void Parse(fstream& fin, const char* outputFilename);
private:
    void ParseHeader(fstream& fin, FLVHeader& header);
    void ParseTags(fstream& fin, const FLVHeader& header);
    void ProcessTag(fstream& fin, TagHeader& tagHeader);
};
```

## 2.2. FLV Header表示的头部

- 结构：包含文件类型标志、版本号、流信息等。
- 代码示例：

```cpp
struct FLVHeader{
    char signature[3]; // "FLV"
    char version;      // 版本号
    uint32_t flags;
    uint32_t headerSize;
};
```

## 2.3. 标签

### 2.3.1. 标签头部

- 结构：包含标签类型、数据大小、时间戳等。
- 代码示例：

```cpp
struct TagHeader{
    uint8_t tagType;
    uint32_t dataSize;
    uint32_t timestamp;
    uint32_t streamId;
};
```

### 2.3.2. 标签数据

### 2.3.2.1. script类型的标签

- 功能：通常包含脚本数据或元数据。
- 代码示例：

```cpp
void ParseScriptTag(fstream& fin, const TagHeader& header){
    uint8_t* tagData = new uint8_t[header.dataSize];
    fin.read((char*)tagData, header.dataSize);
    // 解析脚本标签
    delete[] tagData;
}
```

### 2.3.2.2. 音频标签

- 功能：包含音频流数据。
- 代码示例：

```cpp
void ParseAudioTag(fstream& fin, const TagHeader& header){
    uint8_t* tagData = new uint8_t[header.dataSize];
    fin.read((char*)tagData, header.dataSize);
    // 解析音频标签
    delete[] tagData;
}
```

### 2.3.2.3. 视频标签

- 功能：包含视频流数据。
- 代码示例：

```cpp
void ParseVideoTag(fstream& fin, const TagHeader& header){
    uint8_t* tagData = new uint8_t[header.dataSize];
    fin.read((char*)tagData, header.dataSize);
    // 解析视频标签
    delete[] tagData;
}
```

# 2.4. 解析FLV头部

- 功能：从FLV文件中读取并解析头部信息。
- 代码示例：

```cpp
void CFlvParser::ParseHeader(fstream& fin, FLVHeader& header){
    fin.read(header.signature, 3);
    header.version = fin.get();
    fin.read((char*)&header.flags, 3);
    header.headerSize = (header.flags & 0x01) ? 0x09 : 0x05;
}
```

# 2.5. 入口函数

- 功能：程序的主要入口，调用解析函数。
- 代码示例：

```cpp
int main(int argc, char *argv[]){
    // ...
    CFlvParser parser;
    parser.Parse(fin, argv[2]);
    // ...
}
```

# 2.6. FLV头部解析函数

- 功能：解析FLV文件的头部。
- 代码示例：

```cpp
void CFlvParser::ParseHeader(fstream& fin, FLVHeader& header){
    fin.read(header.signature, 3);
    header.version = fin.get();
    fin.read((char*)&header.flags, 3);
    header.headerSize = (header.flags & 0x01) ? 0x09 : 0x05;
}
```

# 3. 解析视频标签

## 3.1. 标签的解析过程

- 功能：解析视频标签，包括视频帧的信息。
- 代码示例：

```cpp
void ParseVideoTag(fstream& fin, const TagHeader& header){
    uint8_t* tagData = new uint8_t[header.dataSize];
    fin.read((char*)tagData, header.dataSize);
    // 解析视频帧数据
    delete[] tagData;
}
```

## 3.2. 解析标签头部的函数

- 功能：解析FLV文件中的每个标签的头部信息。
- 代码示例：

```cpp
bool ReadTagHeader(fstream& fin, TagHeader& header){
    return fin.read((char*)&header, sizeof(TagHeader));
}
```

# 4. 解析视频标签

## 4.1. 入口函数CreateTag

- 功能：创建视频标签的入口函数。
- 代码示例：

```cpp
void CreateVideoTag(fstream& fin, const TagHeader& header, ofstream& fout){
    uint8_t* tagData = new uint8_t[header.dataSize];
    fin.read((char*)tagData, header.dataSize);
    fout.write((const char*)&header, sizeof(TagHeader));
    fout.write((const char*)tagData, header.dataSize);
    delete[] tagData;
}
```

## 4.2. 创建视频标签

- 功能：根据解析的头部信息创建视频标签。
- 代码示例：

```cpp
void CreateVideoTag(fstream& fin, const TagHeader& header, ofstream& fout){
    uint8_t* tagData = new uint8_t[header.dataSize];
    fin.read((char
*)tagData, header.dataSize);
    fout.write((const char*)&header, sizeof(TagHeader));
    fout.write((const char*)tagData, header.dataSize);
    delete[] tagData;
}
```

## 4.3. 解析视频配置信息

- 功能：解析视频流的配置信息，如编码格式、分辨率等。
- 代码示例：

```cpp
void ParseVideoConfig(fstream& fin){
    uint8_t configData[5];
    fin.read((char*)configData, 5);
    // 解析视频配置信息
}
```

## 4.4. 解析视频数据

- 功能：解析视频帧数据。
- 代码示例：

```cpp
void ParseVideoData(fstream& fin, uint32_t dataSize){
    uint8_t* videoData = new uint8_t[dataSize];
    fin.read((char*)videoData, dataSize);
    // 解析视频数据
    delete[] videoData;
}
```

## 4.5. 自定义的视频处理

- 功能：根据需要对视频数据进行自定义处理。
- 代码示例：

```cpp
void CustomVideoProcessing(vector<uint8_t>& videoData){
    // 自定义视频数据处理
}
```

# 5. 解析音频标签

## 5.1. 入口函数CreateTag

- 功能：创建音频标签的入口函数。
- 代码示例：

```cpp
void CreateAudioTag(fstream& fin, const TagHeader& header, ofstream& fout){
    uint8_t* tagData = new uint8_t[header.dataSize];
    fin.read((char*)tagData, header.dataSize);
    fout.write((const char*)&header, sizeof(TagHeader));
    fout.write((const char*)tagData, header.dataSize);
    delete[] tagData;
}
```

## 5.2. 创建音频标签

- 功能：根据解析的头部信息创建音频标签。
- 代码示例：

```cpp
void CreateAudioTag(fstream& fin, const TagHeader& header, ofstream& fout){
    uint8_t* tagData = new uint8_t[header.dataSize];
    fin.read((char*)tagData, header.dataSize);
    fout.write((const char*)&header, sizeof(TagHeader));
    fout.write((const char*)tagData, header.dataSize);
    delete[] tagData;
}
```

## 5.3. 解析音频标签

- 功能：解析音频流的数据。
- 代码示例：

```cpp
void ParseAudioTag(fstream& fin, const TagHeader& header){
    uint8_t* tagData = new uint8_t[header.dataSize];
    fin.read((char*)tagData, header.dataSize);
    // 解析音频标签
    delete[] tagData;
}
```

## 5.4. 处理音频配置

- 功能：解析音频流的配置信息，如编码格式、采样率等。
- 代码示例：

```cpp
void ParseAudioConfig(fstream& fin){
    uint8_t configData[2];
    fin.read((char*)configData, 2);
    // 解析音频配置信息
}
```

## 5.5. 处理原始音频数据

- 功能：处理原始音频数据，可能包括解码、重编码等。
- 代码示例：

```cpp
void ProcessRawAudioData(vector<uint8_t>& audioData){
    // 处理原始音频数据
}
```

# 6. 解析其他标签

## 6.1. 入口函数CreateTag

- 功能：创建其他类型标签的入口函数。
- 代码示例：

```cpp
void CreateOtherTag(fstream& fin, const TagHeader& header, ofstream& fout){
    uint8_t* tagData = new uint8_t[header.dataSize];
    fin.read((char*)tagData, header.dataSize);
    fout.write((const char*)&header, sizeof(TagHeader));
    fout.write((const char*)tagData, header.dataSize);
    delete[] tagData;
}
```

## 6.2. 解析普通标签

- 功能：解析非视频、非音频的其他类型标签。
- 代码示例：

```cpp
void ParseOtherTag(fstream& fin, const TagHeader& header){
    uint8_t* tagData = new uint8_t[header.dataSize];
    fin.read((char*)tagData, header.dataSize);
    // 解析其他类型的标签
    delete[] tagData;
}
```
