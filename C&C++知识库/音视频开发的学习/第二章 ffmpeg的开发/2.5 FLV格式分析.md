# 2.5 FLV格式分析

[FLV格式分析-FLV封装格式剖析.pdf](../PDF/FLV格式分析-FLV封装格式剖析.pdf)

![大体的解析结构](../imapg/image253.png)

**自己的总结**

1. flv文件解析：flv文件首先分为文件头，元数据和数据包，文件头在每个完整的flv文件中只有一个，元数据在每个flv文件中只有一个，数据包可以有多个，数据包中包含音频，视频和脚本数据。
2. 文件头：文件头包含文件格式版本和其他基本信息。
3. 元数据：元数据包含视频和音频流的描述信息，如时长，宽高，编码格式等。
4. 数据包：数据包包含实际的音视频数据，每个数据包都有一个类型标识（视频，音频或脚本数据）。

## 1. FLV格式简介

FLV（Flash Video）是一种用于传输和存储视频、音频和数据的容器文件格式。最初由Macromedia开发，后被Adobe收购，广泛用于Adobe Flash Player和Adobe AIR中。FLV格式因其高效的流媒体传输能力而广受欢迎，尤其是在早期的在线视频网站中。

### 1.1. FLV格式的特点

- **容器格式**：FLV是一种容器格式，可以包含多种类型的编码视频和音频流。
- **视频编码**：通常使用H.263、VP6或H.264编码。
- **音频编码**：通常使用MP3、AAC或Nellymoser编码。
- **流媒体支持**：FLV格式支持流媒体传输，适合网络视频播放。
- **文件扩展名**：通常为`.flv`。

### 1.2. FLV文件结构

FLV文件由以下几个部分组成：

- **文件头（Header）**：包含文件格式版本和其他基本信息。
- **元数据（Metadata）**：包含视频和音频流的描述信息，如时长、宽高、编码格式等。
- **数据包（Tag）**：包含实际的音视频数据，每个数据包都有一个类型标识（视频、音频或脚本数据）。

一个标准的FLV格式文件的结构如下图所示：

![FLV文件结构](../imapg/image251.png)

flv文件的详细结构如下：

![flv文件的详细结构](../imapg/image252.png)

## 2. FLV文件的详细结构

FLV文件的详细结构如下：

- **文件头**：9字节，包含FLV文件的标识和版本信息。
- **文件大小**：4字节，指示文件的总大小。
- **流媒体标志**：1字节，指示文件是否为流媒体。
- **音视频标记**：1字节，指示文件中是否包含音频和视频流。
- **第一个Tag的大小**：4字节，指示第一个Tag的大小。

## 3. FLV Tag结构

FLV文件中的Tag结构如下：

| 序号 | 字段名          | 类型   | 描述                           |
| ---- | --------------- | ------ | ------------------------------ |
| 1    | Tag Type        | UI8    | Tag的类型，音频、视频、脚本数据 |
| 2    | Data Size       | UI24   | Tag数据的大小                  |
| 3    | Timestamp       | UI24   | Tag的时间戳                    |
| 4    | Timestamp Ext   | UI8    | 时间戳扩展                      |
| 5    | Stream ID       | UI24   | 流ID，一般为0                  |
| 6    | Data            | UI8*   | Tag的具体数据                  |

## 4. Script Data Tag

Script Data Tag用于存放FLV文件中的元数据信息，如视频的宽高、帧率等。这些信息通常存放在FLV文件中的第一个Tag中。

### Script Data格式

| 序号 | 字段名          | 字节数 | 描述                           |
| ---- | --------------- | ------ | ------------------------------ |
| 1    | Name Length     | 2      | 名称长度                       |
| 2    | Name            | 可变   | 名称字符串                     |
| 3    | Value Type      | 1      | 值类型                         |
| 4    | Value           | 可变   | 值                             |

## 5. Audio Tag

音频Tag包含音频数据的参数信息和实际音频数据。

### 音频参数信息

| 位位置 | 描述                       |
| ------ | -------------------------- |
| 0-3    | 音频编码格式（SoundFormat）|
| 4-5    | 采样率（SoundRate）        |
| 6      | 采样精度（SoundSize）      |
| 7      | 声道类型（SoundType）      |

## 6. Video Tag

视频Tag包含视频数据的参数信息和实际视频数据。

### 视频参数信息

| 位位置 | 描述                       |
| ------ | -------------------------- |
| 0-3    | 帧类型（FrameType）        |
| 4-7    | 编码格式（CodecID）        |
