# AVCodec编解码

## 1. AVCodec的简介

AVCodec是FFmpeg库中的一个核心组件，用于处理音视频编解码。FFmpeg是一个开源的多媒体处理库，广泛应用于音视频处理、流媒体传输等领域。AVCodec提供了对多种音视频编解码器的支持，使得开发者可以方便地进行音视频的编码和解码操作。

### 编码（Encoding）

编码是将原始的音视频数据压缩成特定格式的过程。AVCodec支持多种音视频编码格式，如H.264、H.265、VP8、VP9、AAC、MP3等。通过使用AVCodec，开发者可以将原始的音视频数据编码为这些格式，以便于存储和传输。

### 解码（Decoding）

解码是将压缩的音视频数据还原为原始数据的过程。AVCodec支持多种音视频解码格式，如H.264、H.265、VP8、VP9、AAC、MP3等。通过使用AVCodec，开发者可以将压缩的音视频数据解码为原始数据，以便于播放和处理。

## 2. AVCodec的主要函数

在FFmpeg库中，AVCodec提供了一系列函数用于音视频的编码和解码。以下是一些主要的函数：

## 编码相关函数

### avcodec_find_encoder()
函数原型：
```c
const AVCodec* avcodec_find_encoder	(enum AVCodecID id)	
```
- **描述**：查找指定编码格式的编码器。
- **参数**：编码格式的ID（如AV_CODEC_ID_H264）。
- **返回值**：指向编码器的指针。

### avcodec_alloc_context3()
函数原型
```c
AVCodecContext* avcodec_alloc_context3(const AVCodec *codec)	
```
- **描述**：分配并初始化一个AVCodecContext。
- **参数**：指向编码器的指针。
- **返回值**：指向AVCodecContext的指针。

### avcodec_open2()
函数原型：
```c
int avcodec_open2(AVCodecContext *avctx,const AVCodec *codec,AVDictionary **options)	
```
- **描述**：初始化AVCodecContext以使用指定的编码器。
- **参数**：指向AVCodecContext的指针、指向编码器的指针、以及可选的字典参数。
- **返回值**：0表示成功，负值表示失败。

### avcodec_send_frame()
函数原型：
```c
int avcodec_send_frame(AVCodecContext *avctx,const AVFrame *frame)
```
- **描述**：向编码器发送一个AVFrame进行编码。
- **参数**：指向AVCodecContext的指针、指向AVFrame的指针。
- **返回值**：0表示成功，负值表示失败。

### avcodec_receive_packet()
函数原型：
```c
int avcodec_receive_packet(AVCodecContext *avctx,AVPacket *avpkt)
```
- **描述**：从编码器接收一个编码后的AVPacket。
- **参数**：指向AVCodecContext的指针、指向AVPacket的指针。
- **返回值**：0表示成功，负值表示失败。

## 解码相关函数

### avcodec_find_decoder()
函数原型：
```c
const AVCodec* avcodec_find_decoder(enum AVCodecID id)	
```
- **描述**：查找指定解码格式的解码器。
- **参数**：解码格式的ID（如AV_CODEC_ID_H264）。
- **返回值**：指向解码器的指针。

### avcodec_alloc_context3()
函数原型
```c
AVCodecContext* avcodec_alloc_context3(const AVCodec *codec)
```
- **描述**：分配并初始化一个AVCodecContext。
- **参数**：指向解码器的指针。
- **返回值**：指向AVCodecContext的指针。

### avcodec_open2()
函数原型
```c
int avcodec_open2(AVCodecContext *avctx,const AVCodec *codec,AVDictionary **options)
```
- **描述**：初始化AVCodecContext以使用指定的解码器。
- **参数**：指向AVCodecContext的指针、指向解码器的指针、以及可选的字典参数。
- **返回值**：0表示成功，负值表示失败。

### avcodec_send_packet()
函数原型
```c
int avcodec_send_packet(AVCodecContext *avctx,const AVPacket *avpkt)
```
- **描述**：向解码器发送一个AVPacket进行解码。
- **参数**：指向AVCodecContext的指针、指向AVPacket的指针。
- **返回值**：0表示成功，负值表示失败。

### avcodec_receive_frame()
函数原型
```c
int avcodec_receive_frame(AVCodecContext *avctx, AVFrame *frame);
```
- **描述**：从解码器接收一个解码后的AVFrame。
- **参数**：指向AVCodecContext的指针、指向AVFrame的指针。
- **返回值**：0表示成功，负值表示失败。

## 其他常用函数

### av_frame_alloc()
函数原型
```c
AVFrame *av_frame_alloc(void);
```
- **描述**：分配一个AVFrame并初始化其字段。
- **返回值**：指向AVFrame的指针。

### av_frame_free()
函数原型
```c
void av_frame_free(AVFrame **frame);
```
- **描述**：释放一个AVFrame及其数据。
- **参数**：指向指向AVFrame的指针的指针。

### av_packet_alloc()
函数原型
```c
AVPacket *av_packet_alloc(void);
```
- **描述**：分配一个AVPacket并初始化其字段。
- **返回值**：指向AVPacket的指针。

### av_packet_free()
函数原型
```c
void av_packet_free(AVPacket **pkt);
```
- **描述**：释放一个AVPacket及其数据。
- **参数**：指向指向AVPacket的指针的指针。

### avcodec_free_context()
函数原型
```c
void avcodec_free_context(AVCodecContext **avctx);
```
- **描述**：释放一个AVCodecContext及其数据。
- **参数**：指向指向AVCodecContext的指针的指针。

## 3. AVCodec的数据结构

在FFmpeg库中，AVCodec相关的数据结构是音视频编解码操作的核心。以下是一些主要的数据结构及其描述：

### AVCodec
- **描述**：描述一个编解码器的结构体，包含编解码器的名称、类型、ID、功能指针等信息。
- **用途**：主要用于查找和初始化编解码器。

### AVCodecContext
- **描述**：描述编解码器上下文的结构体，包含编解码器的配置参数、状态信息等。
- **用途**：用于实际的编码和解码操作。

### AVCodecParameters
- **描述**：包含编解码器参数的结构体，如编码类型、比特率、采样率、分辨率等。
- **用途**：用于从AVStream中提取编解码器参数并传递给AVCodecContext。

### AVPacket
- **描述**：描述编码后的数据包，包含压缩的音频或视频数据。
- **用途**：用于在编码和解码过程中传递数据。

### AVFrame
- **描述**：描述解码后的原始数据帧，包含未压缩的音频或视频数据。
- **用途**：用于在解码后存储和处理数据。

### AVSubtitle
- **描述**：描述字幕数据的结构体，包含字幕文本、时间戳等信息。
- **用途**：用于处理字幕流。

### 数据结构的详细描述

#### AVCodec
- **名称**：编解码器的名称。
- **类型**：编解码器的类型（音频、视频、字幕）。
- **ID**：编解码器的唯一标识符。
- **功能指针**：指向具体编解码操作的函数指针。

#### AVCodecContext
- **比特率**：编码或解码的比特率。
- **宽度和高度**：视频的分辨率。
- **采样率**：音频的采样率。
- **通道数**：音频的通道数。
- **像素格式**：视频的像素格式。
- **时间基**：时间基，用于时间戳计算。
- **帧率**：视频的帧率。
- **状态信息**：编解码器的状态信息。

#### AVCodecParameters
- **编码类型**：音频或视频的编码类型。
- **比特率**：编码的比特率。
- **采样率**：音频的采样率。
- **分辨率**：视频的分辨率。
- **通道数**：音频的通道数。

#### AVPacket
- **数据**：编码后的音频或视频数据。
- **大小**：数据的大小。
- **时间戳**：数据包的时间戳。
- **流索引**：数据包所属的流的索引。

#### AVFrame
- **数据**：解码后的原始音频或视频数据。
- **行大小**：每行数据的大小（视频）。
- **样本数**：音频样本的数量。
- **时间戳**：数据帧的时间戳。
- **格式**：数据的格式（音频或视频）。

#### AVSubtitle
- **文本**：字幕文本。
- **时间戳**：字幕的时间戳。
- **格式**：字幕的格式。