# AVFormat编解码

## 1. AVFormat的简介

需要包含的头文件

```c
#include <libavutil/avutil.h>
#include <libavformat/avformat.h>
```

AVFormat 是 FFmpeg 中的一个重要模块，主要用于处理多媒体文件的封装和解封装。它在音视频开发中起着关键作用，提供了处理多媒体文件格式和协议的功能。以下是 AVFormat 在音视频开发中的主要作用和功能：

1. 封装和解封装（Demuxing and Muxing）
解封装（Demuxing）：从多媒体文件或流中提取音频和视频数据。AVFormat 可以识别多种多媒体容器格式（如 MP4、AVI、MKV 等），并将其分离成独立的音频和视频流。
封装（Muxing）：将音频和视频数据封装到多媒体容器中。AVFormat 支持将音频和视频流合并成一个文件，适用于多种输出格式。
2. 协议处理（Protocol Handling）
输入协议：支持多种输入协议，如 HTTP、RTSP、RTMP、FTP 等，可以从网络流或本地文件中读取数据。
输出协议：支持多种输出协议，如 HTTP、RTSP、RTMP 等，可以将处理后的数据流发送到网络或保存到本地文件。
3. 格式检测和信息提取（Format Detection and Information Extraction）
格式检测：自动检测输入文件或流的格式，识别音频和视频编解码器。
信息提取：提取多媒体文件的元数据，如时长、比特率、分辨率、编码格式等。
4. 时间戳和同步（Timestamp and Synchronization）
时间戳处理：处理音频和视频流的时间戳，确保音视频同步。
同步处理：在多媒体播放或处理过程中，保持音频和视频的同步。
5. 流处理（Stream Handling）
流管理：管理多媒体文件中的多个音频和视频流，支持多音轨和多字幕轨道。
流选择：选择特定的音频或视频流进行处理或播放。
6. 数据读取和写入（Data Reading and Writing）
数据读取：从多媒体文件或流中读取音频和视频数据包。
数据写入：将音频和视频数据包写入多媒体文件或发送到网络流。
7. 错误处理和恢复（Error Handling and Recovery）
错误检测：检测多媒体文件或流中的错误，如损坏的数据包、丢失的帧等。
错误恢复：尝试从错误中恢复，继续处理或播放多媒体数据。

## 2. AVFormat的主要函数

AVFormat 模块提供了一系列函数，用于处理多媒体文件的封装和解封装操作。以下是 AVFormat 模块中常用的函数：

### 2.1 初始化和注册
初始化 libavformat 并注册所有的封装器和解封装器。通常在程序开始时调用一次。

```c
// 注册所有的封装器和解封装器
void av_register_all(void);
```

### 2.2 打开输入文件或流
打开一个输入文件或流，并读取其头部信息。初始化 AVFormatContext 结构体。

```c
int avformat_open_input(AVFormatContext **ps, const char *url, AVInputFormat *fmt, AVDictionary **options);
```

### 2.3 获取流信息
读取多媒体文件或流的流信息，填充 AVFormatContext 结构体中的流信息。

```c
// 获取流信息
int avformat_find_stream_info(AVFormatContext *ic, AVDictionary **options);
```

### 2.4 读取数据包
从输入文件或流中读取一个数据包。数据包包含编码后的音视频数据。
    
```c
// 读取一个数据包
int av_read_frame(AVFormatContext *s, AVPacket *pkt);
```

### 2.5 寻找特定帧
在输入文件或流中寻找特定的帧，用于定位到指定的时间戳。

```c
// 在流中寻找特定的帧
int av_seek_frame(AVFormatContext *s, int stream_index, int64_t timestamp, int flags);
```

### 2.6 关闭输入流
关闭输入文件或流，并释放 AVFormatContext 结构体及其相关资源

```c
// 关闭输入流   
void avformat_close_input(AVFormatContext **s);
```

### 2.7 分配和释放 AVFormatContext
分配和释放 AVFormatContext 结构体。

```c
// 分配 AVFormatContext
AVFormatContext *avformat_alloc_context(void);

// 释放 AVFormatContext
void avformat_free_context(AVFormatContext *s);
```

### 2.7 写入输出文件头部

写入输出文件的头部信息，初始化输出文件的 AVFormatContext 结构体。

```c
int avformat_write_header(AVFormatContext *s, AVDictionary **options);
```

### 2.8 写入数据包
将编码后的数据包写入输出文件或流。

```c
int av_write_frame(AVFormatContext *s, AVPacket *pkt);
```

### 2.9 写入输出文件尾部
写入输出文件的尾部信息，完成输出文件的写入。

```c
int av_write_trailer(AVFormatContext *s);
```

## 3. AVFormat的数据结构

### 3.1 AVFormatContext
AVFormatContext 是 FFmpeg 中最重要的结构体之一，包含了多媒体文件或流的格式信息、I/O 上下文、流信息等

```c
typedef struct AVFormatContext {
    const AVClass *av_class; /**< 信息的AVClass */
    struct AVInputFormat *iformat; /**< 输入格式 */
    struct AVOutputFormat *oformat; /**< 输出格式 */
    void *priv_data; /**< 私有数据 */
    AVIOContext *pb; /**< I/O上下文 */
    int ctx_flags; /**< 上下文标志 */
    unsigned int nb_streams; /**< 流的数量 */
    AVStream **streams; /**< 流的数组 */
    char filename[1024]; /**< 文件名 */
    // 其他字段...
} AVFormatContext;
```

### 3.2 AVInputFormat
AVInputFormat 是输入格式的结构体，包含了输入格式的名称、扩展名、MIME 类型等信息。

```c
typedef struct AVInputFormat {
    const char *name; /**< 格式名称 */
    const char *long_name; /**< 格式的长名称 */
    int flags; /**< 标志 */
    const char *extensions; /**< 支持的文件扩展名 */
    // 其他字段...
} AVInputFormat;
```

### 3.3 AVOutputFormat
AVOutputFormat 是输出格式的结构体，包含了输出格式的名称、扩展名、MIME 类型等信息。

```c
typedef struct AVOutputFormat {
    const char *name; /**< 格式名称 */
    const char *long_name; /**< 格式的长名称 */
    const char *mime_type; /**< MIME 类型 */
    const char *extensions; /**< 支持的文件扩展名 */
    // 其他字段...
} AVOutputFormat;
```

### 3.4 AVStream
AVStream 是音频或视频流的结构体，包含了流的索引、编解码器、时间基、时长等信息。

```c
typedef struct AVStream {
    int index; /**< 流的索引 */
    AVCodecContext *codec; /**< 编解码上下文 */
    AVRational time_base; /**< 时间基准 */
    int64_t start_time; /**< 开始时间 */
    int64_t duration; /**< 持续时间 */
    // 其他字段...
} AVStream;
```

### 3.5 AVPacket
AVPacket 是数据包的结构体，包含了编码后的音视频数据、时间戳、时长等信息。

```c
typedef struct AVPacket {
    int64_t pts; /**< 显示时间戳 */
    int64_t dts; /**< 解码时间戳 */
    uint8_t *data; /**< 数据指针 */
    int size; /**< 数据大小 */
    // 其他字段...
} AVPacket;
```

### 3.6 AVCodecContext
AVCodecContext 是编解码器的上下文结构体，包含了编解码器的参数、状态、帧率、比特率等信息。

```c
typedef struct AVCodecContext {
    AVCodec *codec; /**< 编解码器 */
    int width; /**< 视频宽度 */
    int height; /**< 视频高度 */
    AVRational time_base; /**< 时间基准 */
    int bit_rate; /**< 比特率 */
    // 其他字段...
} AVCodecContext;
```

## 4. AVFormat解封装

// 封装
// 解封装
// 协议处理
// 格式检查和信息提取
// 时间戳和同步
// 流处理
// 数据读取和写入
// 错误处理和恢复

### 4.1 封装与解封装
封装（Muxing）：将音频和视频数据封装到多媒体容器中。AVFormat 支持将音频和视频流合并成一个文件，适用于多种输出格式。
解封装（Demuxing）：从多媒体文件或流中提取音频和视频数据。AVFormat 可以识别多种多媒体容器格式（如 MP4、AVI、MKV 等），并将其分离成独立的音频和视频流。

1. 解封装的过程
```c
初始化库：初始化FFmpeg库，确保所有的编解码器和格式支持已注册。在ffmpeg最新的7版本当中已经弃用这个接口
打开文件：使用avformat_open_input函数打开多媒体文件，并创建一个AVFormatContext来存储文件格式信息。
查找流信息：使用avformat_find_stream_info函数读取文件的流信息，这样可以获取到文件中包含的音频和视频流。
查找解码器：遍历文件中的流，找到音频和视频流，并使用avcodec_find_decoder函数找到对应的解码器。
初始化解码器：使用avcodec_open2函数初始化解码器，并创建一个AVCodecContext来存储解码器信息。
读取数据包：使用av_read_frame函数从文件中读取数据包（AVPacket），并根据数据包的流索引判断是音频还是视频数据。
解码数据包：使用avcodec_send_packet和avcodec_receive_frame函数将数据包发送到解码器，并接收解码后的帧（AVFrame）。
处理解码后的数据：对解码后的音频和视频帧进行处理，例如保存到文件或进行进一步的处理。
释放资源：完成解码后，释放所有分配的资源，包括AVFormatContext、AVCodecContext、AVFrame和AVPacket等
```