# MP4格式分析

## 1. MP4文件的简介

MP4（MPEG-4 Part 14）是一种常见的多媒体容器格式，用于存储视频、音频、字幕和其他数据。它是MPEG-4标准的一部分，由国际标准化组织（ISO）定义。MP4文件格式广泛应用于视频存储、流媒体传输和数字版权管理（DRM）等领域。

### 主要特点

- **多媒体容器**：MP4文件可以包含多种类型的媒体数据，包括视频、音频、字幕和元数据。
- **高效压缩**：MP4文件通常使用高效的编解码器（如H.264、AAC）进行压缩，提供高质量的音视频体验。
- **流媒体支持**：MP4文件支持流媒体传输，可以在网络环境中进行实时播放。
- **广泛兼容**：MP4文件格式被广泛支持，几乎所有的现代媒体播放器和设备都可以播放MP4文件。

### 应用场景

- **视频存储**：MP4文件常用于存储电影、电视节目、家庭视频等。
- **流媒体传输**：MP4文件广泛应用于在线视频平台（如YouTube、Netflix）和视频会议系统。
- **数字版权管理**：MP4文件支持DRM技术，用于保护版权内容。
- **移动设备**：MP4文件格式被广泛应用于智能手机、平板电脑等移动设备。

### 文件头部信息

一个封装的MP4文件头部通常包含以下信息：

#### 文件格式信息
- **major_brand**：主要品牌，表示文件的类型。
- **minor_version**：次要版本号。
- **compatible_brands**：兼容品牌列表。

#### 文件元数据
- **title**：标题。
- **artist**：艺术家。
- **album**：专辑。
- **genre**：流派。
- **year**：年份。
- **comment**：评论。

#### 时长和比特率
- **duration**：文件的时长。
- **bitrate**：文件的比特率。

#### 流信息
每个流的信息，包括视频流和音频流。
- **codec**：编解码器类型（如H.264、AAC）。
- **width** 和 **height**：视频流的宽度和高度。
- **sample_rate**：音频流的采样率。
- **channels**：音频流的通道数。

## 2. MP4文件的结构

```
MP4文件
├── ftyp（文件类型盒）
├── moov（电影盒）
│   ├── mvhd（电影头盒）
│   ├── trak（轨道盒）
│   │   ├── tkhd（轨道头盒）
│   │   ├── mdia（媒体盒）
│   │   │   ├── mdhd（媒体头盒）
│   │   │   ├── hdlr（处理器盒）
│   │   │   ├── minf（媒体信息盒）
│   │   │   │   ├── vmhd（视频媒体信息盒）
│   │   │   │   ├── smhd（声音媒体信息盒）
│   │   │   │   ├── dinf（数据信息盒）
│   │   │   │   ├── stbl（样本表盒）
│   │   │   │   │   ├── stsd（样本描述盒）
│   │   │   │   │   ├── stts（时间样本表盒）
│   │   │   │   │   ├── stsc（样本到块表盒）
│   │   │   │   │   ├── stsz（样本大小表盒）
│   │   │   │   │   ├── stco（块偏移表盒）
├── mdat（媒体数据盒）
├── free/skip（自由空间盒）
```

MP4文件采用盒（Box）结构，每个盒包含特定类型的数据。盒结构是MP4文件的基础，允许文件包含多种类型的媒体数据和元数据。以下是MP4文件的详细结构分析：

### 盒（Box）结构概述

MP4文件由多个盒（Box）组成，每个盒包含一个头部和数据部分。盒可以包含其他盒，形成层次结构。每个盒的基本结构如下：

- **Box头部**：包含Box的类型和大小。
- **Box数据**：包含具体的媒体数据或元数据。

盒（Box）结构的特点

+ 独立性：每个盒都是一个独立的单元，包含自己的头部和数据部分。这使得盒可以独立解析和处理。
+ 层次结构：盒可以包含其他盒，形成层次结构。这种层次结构使得MP4文件可以包含复杂的媒体数据和元数据。
+ 可扩展性：新的盒类型可以添加到MP4文件中，而不会影响现有的盒。这使得MP4文件格式具有很好的可扩展性。

### Box的基本结构

每个Box的头部通常包含以下字段：

- **size（4字节）**：Box的大小，包括头部和数据部分。
- **type（4字节）**：Box的类型，表示Box的内容。

如果Box的大小超过4字节，可以使用扩展大小字段：

- **largesize（8字节，可选）**：Box的扩展大小。

## 3. 常见的Box类型

### 3.1 ftyp（文件类型盒）

- **描述**：包含文件的类型和兼容性信息。
- **字段**：
  - `major_brand`：主要品牌。
  - `minor_version`：次要版本号。
  - `compatible_brands`：兼容品牌列表。

### 3.2 moov（电影盒）

- **描述**：包含文件的元数据和媒体信息。
- **子盒**：
  - **mvhd（电影头盒）**：包含整个文件的全局信息，如时长、时间尺度等。
  - **trak（轨道盒）**：包含每个媒体轨道的信息。
    - **tkhd（轨道头盒）**：包含轨道的基本信息，如轨道ID、时长等。
    - **mdia（媒体盒）**：包含媒体信息。
      - **mdhd（媒体头盒）**：包含媒体的时间和语言信息。
      - **hdlr（处理器盒）**：包含处理器类型信息。
      - **minf（媒体信息盒）**：包含媒体的具体信息。
        - **vmhd（视频媒体信息盒）**：包含视频媒体的特定信息。
        - **smhd（声音媒体信息盒）**：包含音频媒体的特定信息。
        - **dinf（数据信息盒）**：包含数据引用信息。
        - **stbl（样本表盒）**：包含样本描述、时间、大小等信息。
          - **stsd（样本描述盒）**：包含样本格式信息。
          - **stts（时间样本表盒）**：包含样本时间信息。
          - **stsc（样本到块表盒）**：包含样本到块的映射信息。
          - **stsz（样本大小表盒）**：包含每个样本的大小信息。
          - **stco（块偏移表盒）**：包含每个块的偏移信息。

### 3.3 mdat（媒体数据盒）

- **描述**：包含实际的媒体数据，如视频帧和音频样本。
- **字段**：媒体数据。

### 3.4 free/skip（自由空间盒）

- **描述**：用于填充和对齐数据。
- **字段**：自由空间数据。