# windbg 调试器

windbg是微软出品的强大调试器，是分析软件异常的利器

widbg之于Windows，就如GDB与Linux

windbg分析问题的两种方式

1. windbg静态分析dump文件（事后分析）
2. windbg动态调试目标进程（现场调试，也可以导出dump文件事后分析）

dump文件分类

1. mini dump文件（文件较小，大概几MB左右）
2. 全dump文件（文件较大，接近程序的虚拟内存大小）

dump文件的生成方式

1. 从动态调试的windbg中导出dump文件（全dunp文件）使用.dump命令导出dump文件，供事后分析
2. 从Windows任务管理器中导出dump文件，在任务管理器中找到目标进程，右键点击该进程，导出转储文件

pdb文件

PDB：Program Databse File ,程序数据库文件，存放了二进制文件中所有函数及变量的符号，还有一些调试用的信息，要查看完整的函数调用信息及其变量信息，都需要pdb文件

在vs的工程配置中是默认生成pdb文件的

使用pdb文件，要注意文件名和项目名称是一致的，时间戳要一致

windbg的安装

可以安装微软商店版本的，搜索windbg即可

或者安装在线windbg的10.0版本

# windbg静态分析dump文件

需要打开程序生成的dump文件，以及程序的pdb文件

注意这里的pdb文件时间戳与当前的程序时间戳一致，即使编译后也要一致，否则就windbg就加载不上

1. 首先查看发生的异常类型

Access violation 内存访问违例

Integer divided 编译zero 除 0 异常

Stack overflow线程栈溢出

其他类型

1. 使用【.ecxr】命令切换到发生异常的线程中，查看发生异常的那条汇编指令，可能找到初步线索

内存中访问了小于64kb地址的内存，引发内存访问违例，可能是空指针或野指针引发的

指令中访问了内核态的内存地址，引发内存访问违例-可能是内存被越界篡改引发的，也可能是野指针引发的

1. 使用kn/kv/kp查看函数调用堆栈

第一次查看主要模块的信息，以确定要找那些模块的pdb文件。没有pdb文件，函数调用堆栈中看不到具体的函数名和行号

1. 根据函数调用堆栈中的模块名称，使用lm命令查看模块时间戳，然后去找对应版本的pdb文件
2. 将pdb文件路径设置到windbg中，使用【.excr】重新切换到发生异常的程序中，然后使用kn/kv/kp命令重新查看函数调用堆栈（堆栈中会显示具体的函数名和行号）
3. 如果堆栈中没有显示具体的函数名和行号，应该是pdb加载失败

可能是pdb版本不对

可能是windbg没有加载起来，使用lm命令确认

使用【.reload】命令强制加载pdb

1. 将函数调用堆栈与c++源码结合起来分析，去排查引发问题的原因
2. 有时候可能需要查看函数中局部变量或者函数所在类对象的成员变量的值，可能是关键线索

minidump 包含的信息有限，可能查看不到变量的内存

全dump文件，一般可以查看到所有的内存

1. 如果无法查出问题，可能需要IDA查看二进制模块的汇编代码，去辅助分析

# windbg动态调试目标进程的一般步骤

1. 将windbg附加到进程上

程序先启动，将windbg附加到程序进程上

使用windbg启动程序

1. 成功附加到进程上，windbg会中断下来，输入【g】命令将中断跳过去
2. 程序在运行过程中发生异常，调试器windbg会立即感知到并中断下来
3. 加载pdb，查看更详细的函数调用堆栈
4. 将函数调用堆栈与c++源码结合起来分析，去排查引发问题的原因
5. 有时候可能需要查看函数中局部变量或者函数所在类对象的成员变量的值，可能是关键线索-附加到调试时可以查看所有的变量的值
6. 如果短时间内查不出问题，可以使用【.dump】命令将当前上下文导出到dump文件中（全dump文件），事后再详细进行分析

# 什么时候使用windbg动态调试

1. 程序闪退或崩溃时没有生成dump文件，可以尝试将windbg挂载上去跑
2. 使用vs调试时产生异常，看不到完整的函数调用堆栈，可以尝试使用windbg动态调试
3. 程序中检查到不正常，直接将程序abort了表现现象是程序直接闪退，但程序并没有发生c++异常，可以尝试使用windbg动态调试

# windbg常用命令

1. g命令：跳过当前中断，继续运行
2. .ecxr命令，切换到发生异常的线程中，即异常上下文
3. kn/kv/kp：查看当前线程的函数调用堆栈
4. lm命令：查看exe或dll二进制文件的信息，比如路径，时间戳等
5. .reload命令：加载pdb文件
6. ~命令：查看当前进程的所有线程信息
7. ~ns命令：切换到n号线程中
8. !analyze命令：详细分析当前异常，完整的命令为!analyze -v
9. .dump命令：导出dump文件
10. bp/bl/bc断点命令：bp添加断点，bl罗列当前所有的断点，bc清除断点
11. r命令：查看当前线程所有寄存器的值
12. .cls清屏
13. .effmach命令：切换当前进程的上下文